#!/usr/bin/env bash

# üìÇ –ü—É—Ç—å: ~/.local/bin/devsys
# üìå –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: paru, fzf, gum, btop, du, journalctl, pacman, systemctl

# === –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π ===
for cmd in fzf gum btop paru; do
  if ! command -v "$cmd" &>/dev/null; then
    echo "\e[31m[!] –ù–µ –Ω–∞–π–¥–µ–Ω–æ: $cmd\e[0m. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —á–µ—Ä–µ–∑ paru."
    exit 1
  fi
done

# === –¶–≤–µ—Ç–∞ ===
GREEN="\e[32m"
BLUE="\e[34m"
RESET="\e[0m"

# === –û—á–∏—Å—Ç–∫–∞ —Å–∏—Å—Ç–µ–º—ã ===
clean_system() {
  echo -e "${BLUE}üßπ –û—á–∏—â–∞–µ–º systemd –∂—É—Ä–Ω–∞–ª—ã...${RESET}"
  sudo journalctl --vacuum-time=2d
  
  echo -e "${BLUE}üßπ –û—á–∏—â–∞–µ–º pacman-–∫—ç—à...${RESET}"
  sudo paccache -r
  
  echo -e "${BLUE}üßπ –£–¥–∞–ª—è–µ–º —Å–∏—Ä–æ—Ç—ã...${RESET}"
  sudo pacman -Rns $(pacman -Qdtq) 2>/dev/null || echo "–ù–µ—Ç —Å–∏—Ä–æ—Ç"

  echo -e "${BLUE}üì¶ –£–¥–∞–ª—è–µ–º –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ AUR-–ø–∞–∫–µ—Ç—ã...${RESET}"
  paru -Rns $(paru -Qdtq) 2>/dev/null || echo "–ù–µ—Ç —Å–∏—Ä–æ—Ç –≤ AUR"

  echo -e "${BLUE}üìä –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–Ω–æ–µ –º–µ—Å—Ç–æ:${RESET}"
  df -h / | grep -v tmpfs
}

# === –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–µ—Ä–≤–∏—Å–æ–≤ ===
manage_services() {
  selected=$(systemctl list-units --type=service --user | fzf --multi --header="–í—ã–±–µ—Ä–∏ —Å–µ—Ä–≤–∏—Å—ã (–≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑, –ø—Ä–æ–±–µ–ª ‚Äî –≤—ã–±—Ä–∞—Ç—å)" --preview='systemctl status {1}' | awk '{print $1}')
  if [ -z "$selected" ]; then
    echo "–ù–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ"
    return
  fi

  action=$(gum choose "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å" "‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å" "‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å" "üö´ –û—Ç–∫–ª—é—á–∏—Ç—å")

  for svc in $selected; do
    case "$action" in
      *–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å*) systemctl --user restart "$svc" ;;
      *–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å*) systemctl --user stop "$svc" ;;
      *–ó–∞–ø—É—Å—Ç–∏—Ç—å*) systemctl --user start "$svc" ;;
      *–û—Ç–∫–ª—é—á–∏—Ç—å*) systemctl --user disable "$svc" ;;
    esac
  done
}

# === –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã ===
system_update() {
  echo -e "${GREEN}‚¨áÔ∏è –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –ø–∞–∫–µ—Ç—ã...${RESET}"
  sudo pacman -Syu
  echo -e "${GREEN}‚¨áÔ∏è –û–±–Ω–æ–≤–ª—è–µ–º AUR –ø–∞–∫–µ—Ç—ã...${RESET}"
  paru -Syu
}

# === –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–∞–º—è—Ç–∏ —á–µ—Ä–µ–∑ zramctl –∏ sensors ===
show_stats() {
  echo -e "${BLUE}üìä ZRAM:${RESET}"
  zramctl
  echo -e "\n${BLUE}üå° –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã:${RESET}"
  sensors
  echo -e "\n${BLUE}üß† –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏:${RESET}"
  free -h
}

# === –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é ===
main_menu() {
  choice=$(gum choose "üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã" "üßπ –û—á–∏—Å—Ç–∫–∞ –º—É—Å–æ—Ä–∞" "üß† –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É" "‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞–º–∏" "üìà –û—Ç–∫—Ä—ã—Ç—å btop" "üö™ –í—ã–π—Ç–∏")
  case "$choice" in
    "üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã") system_update ;;
    "üßπ –û—á–∏—Å—Ç–∫–∞ –º—É—Å–æ—Ä–∞") clean_system ;;
    "üß† –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É") show_stats ;;
    "‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞–º–∏") manage_services ;;
    "üìà –û—Ç–∫—Ä—ã—Ç—å btop") btop ;;
    *) echo "–í—ã—Ö–æ–¥..."; exit 0 ;;
  esac
}

# === –ó–∞–ø—É—Å–∫ ===

main_menu
