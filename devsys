#!/usr/bin/env bash

# === devsys by –ï–≤–≥–µ–Ω–∏–π ===
VERSION="1.0.3"

REPO_URL="https://github.com/Jake-015kz/devsys.git"
REPO_NAME="devsys"

# === Colors ===
GREEN='\033[1;32m'
RED='\033[1;31m'
YELLOW='\033[1;33m'
RESET='\033[0m'

# === –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–π ===
if [[ $1 == "--version" ]]; then
  echo -e "üî¢ Local version: ${GREEN}$VERSION${RESET}"
  if git ls-remote --tags $REPO_URL &>/dev/null; then
    LATEST=$(git ls-remote --tags $REPO_URL | grep -o 'refs/tags/v[0-9.]*' | sort -V | tail -n1 | sed 's/refs\/tags\///')
    echo -e "üåê Remote version: ${YELLOW}${LATEST}${RESET}"
    [[ "v$VERSION" != "$LATEST" ]] && echo -e "‚ö†Ô∏è –î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è!" || echo -e "‚úÖ –£ –≤–∞—Å –ø–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è."
  else
    echo -e "${RED}‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å GitHub${RESET}"
  fi
  exit 0
fi

# === –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ ===
if [[ $1 == "update" ]]; then
  echo -e "üîÑ ${YELLOW}–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ devsys...${RESET}"
  SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
  if [ -d "$SCRIPT_DIR/.git" ]; then
    git -C "$SCRIPT_DIR" pull origin main && echo -e "‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ!"
  else
    echo -e "${RED}‚ùå –°–∫—Ä–∏–ø—Ç –Ω–µ –±—ã–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —á–µ—Ä–µ–∑ git clone${RESET}"
    echo "üì¶ –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: git clone $REPO_URL ~/.local/bin/devsys"
  fi
  exit 0
fi

# === ASCII HEADER ===
ascii_logo() {
  echo -e "${GREEN}"
  echo "‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïÆ"
  echo "‚îÇ     üöÄ DevSys Utility      ‚îÇ"
  echo "‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïØ"
  echo -e "${RESET}"
}

# === –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é ===
main_menu() {
  ascii_logo
  options=(
    "üì¶ –û–±–Ω–æ–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º—É (paru -Syu)"
    "üßπ –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à, –ª–æ–≥–∏, —Å–∏—Ä–æ—Ç—ã"
    "üß† –ü–æ–∫–∞–∑–∞—Ç—å RAM/ZRAM (zramctl)"
    "üî• –ó–∞–ø—É—â–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã"
    "‚öôÔ∏è  –í–∫–ª—é—á–∏—Ç—å/–æ—Ç–∫–ª—é—á–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã"
    "üîÑ –û–±–Ω–æ–≤–∏—Ç—å DevSys"
    "üî¢ –í–µ—Ä—Å–∏—è DevSys"
    "üö™ –í—ã—Ö–æ–¥"
  )

  selected=$(printf '%s\n' "${options[@]}" | fzf --prompt "üëâ –í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ: " --height 40% --border)

  case "$selected" in
    *"–û–±–Ω–æ–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º—É"*) paru -Syu ;;
    *"–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à"*) cleanup ;;
    *"RAM"*) zramctl && free -h ;;
    *"–ó–∞–ø—É—â–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã"*) systemctl list-units --type=service --state=running ;;
    *"–í–∫–ª—é—á–∏—Ç—å/–æ—Ç–∫–ª—é—á–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã"*) service_toggle ;;
    *"–û–±–Ω–æ–≤–∏—Ç—å DevSys"*) "$0" update ;;
    *"–í–µ—Ä—Å–∏—è"*) "$0" --version ;;
    *) echo "üëã –ü–æ–∫–∞!"; exit 0 ;;
  esac
}

# === –û—á–∏—Å—Ç–∫–∞ —Å–∏—Å—Ç–µ–º—ã ===
cleanup() {
  echo -e "${YELLOW}üßπ –û—á–∏—Å—Ç–∫–∞...${RESET}"
  journalctl --vacuum-time=2d
  sudo pacman -Scc --noconfirm
  sudo pacman -Rns $(pacman -Qtdq 2>/dev/null) --noconfirm
  echo -e "${GREEN}‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞${RESET}"
  echo "üìä –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–æ:"
  df -h | grep -v loop | grep -E '^/dev/'
}

# === –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞–º–∏ ===
service_toggle() {
  all_services=$(systemctl list-unit-files --type=service | awk '{print $1}' | tail -n +2)
  selected=$(echo "$all_services" | fzf --multi --prompt "üß† –í–∫–ª—é—á–∏—Ç—å/–æ—Ç–∫–ª—é—á–∏—Ç—å: ")

  for svc in $selected; do
    if systemctl is-enabled --quiet "$svc"; then
      sudo systemctl disable "$svc"
      echo -e "${YELLOW}–û—Ç–∫–ª—é—á–µ–Ω–æ: $svc${RESET}"
    else
      sudo systemctl enable "$svc"
      echo -e "${GREEN}–í–∫–ª—é—á–µ–Ω–æ: $svc${RESET}"
    fi
  done
}

# === –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é ===
main_menu
